from typing import Any, Dict, Iterable, List, Mapping, Optional, Protocol, Sequence, Tuple, TypeVar, Union

from django.db.models import Model, QuerySet

from mongoengine import QuerySet as MongoQuerySet
from rest_framework.request import Request
from rest_framework.views import APIView

_MT = TypeVar("_MT", bound=Model)

_Q = TypeVar("_Q", bound=Union[QuerySet[Any], MongoQuerySet[Any]])

class _FilterBackendProtocol(Protocol):
    def filter_queryset(self, request: Any, queryset: _Q, view: APIView) -> _Q: ...
    def get_schema_fields(self, view: APIView) -> List[Any]: ...
    def get_schema_operation_parameters(self, view: APIView) -> Any: ...

class BaseFilterBackend:
    def filter_queryset(self, request: Any, queryset: _Q, view: APIView) -> _Q: ...
    def get_schema_fields(self, view: APIView) -> List[Any]: ...
    def get_schema_operation_parameters(self, view: APIView) -> Any: ...

class SearchFilter(BaseFilterBackend):
    search_param: str = ...
    template: str = ...
    lookup_prefixes: Dict[str, str] = ...
    search_title: str = ...
    search_description: str = ...
    def get_search_fields(self, view: APIView, request: Request) -> Any: ...
    def get_search_terms(self, request: Request) -> List[str]: ...
    def construct_search(self, field_name: str) -> str: ...
    def must_call_distinct(self, queryset: QuerySet[Any], search_fields: Any) -> bool: ...
    def to_html(self, request: Request, queryset: QuerySet[Any], view: APIView) -> str: ...

class OrderingFilter(BaseFilterBackend):
    ordering_param: str = ...
    ordering_fields: Optional[Sequence[str]] = ...
    ordering_title: str = ...
    ordering_description: str = ...
    template: str = ...
    def get_ordering(self, request: Request, queryset: QuerySet[Any], view: APIView) -> Sequence[str]: ...
    def get_default_ordering(self, view: APIView) -> Sequence[str]: ...
    def get_default_valid_fields(
        self, queryset: QuerySet[Any], view: Any, context: Mapping[str, Any] = ...
    ) -> List[Tuple[str, str]]: ...
    def get_valid_fields(
        self, queryset: QuerySet[Any], view: Any, context: Mapping[str, Any] = ...
    ) -> List[Tuple[str, str]]: ...
    def remove_invalid_fields(
        self, queryset: QuerySet[Any], fields: Iterable[str], view: Any, request: Request
    ) -> List[str]: ...
    def get_template_context(self, request: Request, queryset: QuerySet[Any], view: APIView) -> Dict[str, Any]: ...
    def to_html(self, request: Request, queryset: QuerySet[Any], view: APIView) -> str: ...
